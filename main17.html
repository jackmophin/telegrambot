<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>
    <style>
    
    .promosgen {
        margin-top: 30px;
        padding: 20px;
        background-color: black;
        border: 1px solid white;
        border-radius: 5px;
        text-align: center;
        align-content: center;
    }
    
    .promosgen input {
        width: 90%;
        margin: 10px;
    }
    
    .company-actions {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    justify-content: center;
}

.company-btn {
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid;
    background: black;
    color: white;
}

.fund-btn {
    border-color: #4CAF50;
}

.delete-btn {
    border-color: #ff4444;
}
    
    #companiesContainer {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
    }
    
    .company-card {
        width: 280px;
        padding: 15px;
        border: 1px solid #444;
        border-radius: 8px;
        background: #111;
        border: 1px solid white;
    }
    
    #total-companies-profit {
        margin-top: 20px;
        font-size: 1.2em;
        padding: 10px;
        border-radius: 5px;
    }
    
.profit-up::before {
    content: '▲';
    color: #4CAF50;
    margin-right: 5px;
}

.profit-down::before {
    content: '▼';
    color: #ff4444;
    margin-right: 5px;
}

.profit-text {
    font-weight: bold;
}

.company-status {
    font-weight: bold;
    color: #4CAF50;
}
.company-status.closed {
    color: #ff4444;
}
.profit-up {
    color: #4CAF50;
}
.profit-down {
    color: #ff4444;
}
</style>
    <style>
@font-face {
    font-family: 'Product Sans';
    src: url('https://jackmophin.github.io/local/fonts/productsans.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}
        body {
            font-family: 'Product Sans', Arial, sans-serif;
            text-align: center;
            background-color: black;
            color: white;
            padding: 20px;
           -webkit-font-smoothing: antialiased; 
           -moz-osx-font-smoothing: grayscale;
           font-smooth: always;      
        }
    .inventory {
        margin-top: 30px;
        padding: 20px;
        background-color: black;
        border: 1px solid white;
        border-radius: 5px;
        text-align: left;
    }
    .inventory-item {
        font-size: 16px;
        margin: 5px 0;
    }
    
        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 20%;
            margin: 20px auto;
            border: 2px solid #ccc;
        }
        .info {
            margin-top: 20px;
        }
        .item-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid white;
            border-radius: 5px;
            background-color: black;
        }
        .item-name {
            font-size: 18px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
        }
        .quantity-control button {
             color: white;
            background-color: black;
            border-radius: 5px;
            border: 1px solid white;
            font-size: 18px;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
        .price {
            font-size: 16px;
        }
        .total-cost {
            font-size: 20px;
            margin-top: 20px;
        }
        
        .total-cost p {
            opacity: 0.5;
            font-size: 15px;
            position: relative;
            top: -10px;
            margin-bottom: -10px;
        }
        .pay-button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .pay-button:hover {
            background-color: #45a049;
        }
        .money-info {
            margin-top: 30px;
            font-size: 18px;
        }
        .subtract-line {
            border-top: 2px solid #000;
            margin: 10px 0;
            width: 60%;
            margin-left: auto;
            margin-right: auto;
        }
        input {
            width: 50px;
            font-size: 18px;
            color: white;
            background-color: black;
            border: 1px solid white;
            border-radius: 4px;
        }
        .remaining-amount {
            font-size: 20px;
            margin-top: 10px;
        }
        
        .category-title {
            font-size: 25px;
            margin: 10px;
        }
        
        .badge {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            position: relative;
            top: -1px;
            margin: 5px;
        }
        
        .i1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid white;
            border-radius: 5px;
            background-color: black;
        }
        
        .i1 input {
            width: 100%;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Добро пожаловать!</h1>
    <img id="avatar" class="avatar" src="" alt="User Avatar">
    <div class="info">
        <h2 id="name">Имя пользователя</h2>
        <p id="username">@username</p>
    </div>

        <div class="category-title">Народ</div>
        <div class="item-container" data-price="1000" id="item-1">
            <div class="item-name">Жилой дом</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-1" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-1">1000</span> ₽</div>
        </div>
        <div class="item-container" data-price="500" id="item-2">
            <div class="item-name">Школа</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-2" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-2">500</span> ₽</div>
        </div>
        <div class="item-container" data-price="2000" id="item-3">
            <div class="item-name">Больница</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-3" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-3">2000</span> ₽</div>
        </div>
        <div class="item-container" data-price="1500" id="item-4">
            <div class="item-name">Детский сад</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-4" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-4">1500</span> ₽</div>
        </div>
        <div class="item-container" data-price="1200" id="item-5">
            <div class="item-name">Парк</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-5" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-5">1200</span> ₽</div>
        </div>
        <div class="item-container" data-price="3000" id="item-6">
            <div class="item-name">Церковь</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-6" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-6">3000</span> ₽</div>
        </div>
        <div class="item-container" data-price="450" id="item-7">
            <div class="item-name">Площадь</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-7" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-7">450</span> ₽</div>
        </div>
        <div class="item-container" data-price="3500" id="item-8">
            <div class="item-name">Магазин</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-8" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-8">3500</span> ₽</div>
        </div>
        <div class="item-container" data-price="2500" id="item-9">
            <div class="item-name">Сельский дом</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-9" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-9">2500</span> ₽</div>
        </div>
        <div class="item-container" data-price="10000" id="item-10">
            <div class="item-name">Спортивный комплекс</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-10" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-10">10000</span> ₽</div>
        </div>
<!-- Категория "Армия" -->
        <div class="category-title">Армия</div>
        <div class="item-container" data-price="50000" id="item-11">
            <div class="item-name">Танк</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-11" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-11">50000</span> ₽</div>
        </div>
        <div class="item-container" data-price="150000" id="item-13">
            <div class="item-name">Самолет</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-13" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-13">150000</span> ₽</div>
        </div>
        <div class="item-container" data-price="25000" id="item-14">
            <div class="item-name">Вертолет</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-14" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-14">25000</span> ₽</div>
        </div>
        <div class="item-container" data-price="10000" id="item-15">
            <div class="item-name">Ракетница</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-15" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-15">10000</span> ₽</div>
        </div>
        <div class="item-container" data-price="20000" id="item-16">
            <div class="item-name">Пушки</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-16" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-16">20000</span> ₽</div>
        </div>
        <div class="item-container" data-price="50000" id="item-17">
            <div class="item-name">Снайперская винтовка</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-17" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-17">50000</span> ₽</div>
        </div>
            <div class="item-container" data-price="60000" id="item-18">
            <div class="item-name">Подводная лодка</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-18" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-18">60000</span> ₽</div>
        </div>
        <div class="item-container" data-price="80000" id="item-19">
            <div class="item-name">Гарнизон</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-19" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-19">80000</span> ₽</div>
        </div>
        <div class="item-container" data-price="120000" id="item-20">
            <div class="item-name">Морской флот</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-20" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-20">120000</span> ₽</div>
        </div>
        <div class="item-container" data-price="5000" id="item-21">
            <div class="item-name">Солдат</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-21" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-21">5000</span> ₽</div>
        </div>
        <!-- Категория "Экономика" -->
        <div class="category-title">Экономика</div>
        <div class="item-container" data-price="12000" id="item-22">
            <div class="item-name">Нефтяная вышка</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-22" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-22">12000</span> ₽</div>
        </div>
        <div class="item-container" data-price="15000" id="item-23">
            <div class="item-name">Завод</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-23">15000</span> ₽</div>
        </div>
        <div class="item-container" data-price="50000" id="item-24">
            <div class="item-name">Аэропорт</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-24" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-24">50000</span> ₽</div>
        </div>
        <div class="item-container" data-price="70000" id="item-25">
            <div class="item-name">Банк</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-25" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-25">70000</span> ₽</div>
        </div>
        <div class="item-container" data-price="12000" id="item-26">
            <div class="item-name">Ферма</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-26" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-26">12000</span> ₽</div>
        </div>
        <div class="item-container" data-price="6000" id="item-27">
            <div class="item-name">Горнодобывающая фабрика</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-27" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-27">6000</span> ₽</div>
        </div>
        <div class="item-container" data-price="25000" id="item-28">
            <div class="item-name">Торговый центр</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-28" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-28">25000</span> ₽</div>
        </div>
        <div class="item-container" data-price="32000" id="item-29">
            <div class="item-name">Энергетическая станция</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-29" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-29">32000</span> ₽</div>
        </div>
        <div class="item-container" data-price="10000" id="item-30">
            <div class="item-name">Рынок</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-30" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-30">10000</span> ₽</div>
        </div>
        <div class="item-container" data-price="2000" id="item-31">
            <div class="item-name">Мельница</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-31" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-31">2000</span> ₽</div>
        </div>
        <div class="item-container" data-price="75000" id="item-41">
            <div class="item-name">Международная торговля</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-41" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-41">75000</span> ₽</div>
        </div>
<!-- Прочее -->
        <div class="category-title">Прочее</div>
        <div class="item-container" data-price="1000" id="item-32">
            <div class="item-name">Интернет</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-32" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-32">1000</span> ₽</div>
        </div>
        <div class="item-container" data-price="77777777" id="item-33">
            <div class="item-name">Скибдм</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-33" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-33">77777777</span> ₽</div>
        </div>
        <div class="item-container" data-price="8000" id="item-34">
            <div class="item-name">Билет банка приколов</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-34" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-34">8000</span> ₽</div>
        </div>
        <div class="item-container" data-price="1500" id="item-35">
            <div class="item-name">Котолазер сломанный</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-35" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-35">1500</span> ₽</div>
        </div>
        <div class="item-container" data-price="3000" id="item-36">
            <div class="item-name">Плюшевый спамтон</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-36" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-36">3000</span> ₽</div>
        </div>
        <div class="item-container" data-price="1" id="item-37">
            <div class="item-name">0₽</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-37" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-37">1</span> ₽</div>
        </div>
        <div class="category-title">Технологии</div>
         <div class="item-container" data-price="4000" id="item-38">
            <div class="item-name">Ученый</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-38" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-38">4000</span> ₽</div>
        </div>
        <div class="item-container" data-price="10000" id="item-39">
            <div class="item-name">Ученый-эксперт</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-39" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-39">10000</span> ₽</div>
        </div>
        <div class="item-container" data-price="70000" id="item-40">
            <div class="item-name">Лаборатория</div>
            <div class="quantity-control">
                <button class="decrease">-</button>
                <input type='number' min="0" id="quantity-40" value="0">
                <button class="increase">+</button>
            </div>
            <div class="price">Цена: <span id="price-40">70000</span> ₽</div>
        </div>
        
        <!-- item-41 ЗАНЯТ ДРУГИМ ПРЕДМЕТОМ, НАЧИНАТЬ С item-42 -->
        
        <div class="i1">
            <div class="item-name">Перевести деньги</div>
            <div class="quantity-control">
                <input type='number' min="0" id="pev" value="0">
                <input type="text" id="pev1" placeholder="С какой целью?">
            </div>
            <button class="pay-button" onclick='dep()'>Перевод</button>
        </div>
    <div class="money-info">
        <p>Текущий баланс: <span id="user-money">0</span> ₽</p>
        <div class="subtract-line"></div>
        <p>После покупки: <span id="remaining-money">0</span> ₽</p>
    </div>

    <div class="total-cost">
        Общая стоимость: <span id="total-cost">0</span> ₽
        <p>(учитывая налог)</p>
    </div>

    <button class="pay-button" id="pay-button" onclick="pay()">Оплатить</button>
    
<div id="companySection">
    <div class="category-title">Ваши компании</div>
    <div id="companiesContainer" class="inventory"></div>
    <button class="pay-button" onclick="showCompanyForm()">Основать компанию (5,000₽)</button>
    <div id="companyForm" style="display:none; margin-top:15px;">
        <div class="i1">
            <input type="text" id="companyName" placeholder="Название корпорации" style="width:90%">
            <input type="url" id="companyAvatar" placeholder="Ссылка на логотип" style="width:90%">
            <input type="number" id="companyBudget" placeholder="Стартовый капитал" min="10000" style="width:90%">
            <button class="pay-button" onclick="createCompany()">Зарегистрировать</button>
        </div>
    </div>
</div>

<script>
// Глобальные объявления
const COMPANY = {
    KEY: 'userCompanies',
    CREATION_COST: 5000,
    MIN_BUDGET: 10000,
    BASE_CHANCE: 0.001,
    PROFIT_RATE: 0.03,
    LOSS_RATE: 0.05
};

// Инициализация компаний
function initCompanies() {
    if(!localStorage.getItem(COMPANY.KEY)) {
        localStorage.setItem(COMPANY.KEY, JSON.stringify([]));
    }
}

// Показ формы создания компании
function showCompanyForm() {
    try {
        const currentBalance = Number(localStorage.getItem('userMoney1')) || 0;
        const companyForm = document.getElementById("companyForm");
        
        if (!companyForm) throw new Error('Форма компании не найдена');
        
        if(currentBalance >= COMPANY.CREATION_COST) {
            companyForm.style.display = "block";
            document.getElementById("companyName").value = '';
            document.getElementById("companyAvatar").value = '';
            document.getElementById("companyBudget").value = '';
        } else {
            alert(`Требуется ${COMPANY.CREATION_COST.toLocaleString()}₽! Ваш баланс: ${currentBalance.toLocaleString()}₽`);
            companyForm.style.display = "none";
        }
    } catch(error) {
        console.error('Ошибка:', error);
        alert('Ошибка при открытии формы');
    }
}

// Создание компании
function createCompany() {
    try {
        const companyName = document.getElementById("companyName").value.trim();
        const companyBudget = parseInt(document.getElementById("companyBudget").value);
        const companyAvatar = document.getElementById("companyAvatar").value;

        // Валидация данных
        if(!companyName || !companyAvatar || isNaN(companyBudget)) {
            alert("Заполните все поля корректно!");
            return;
        }
        
        if(companyBudget < COMPANY.MIN_BUDGET) {
            alert(`Минимальный бюджет: ${COMPANY.MIN_BUDGET.toLocaleString()}₽!`);
            return;
        }

        const companies = JSON.parse(localStorage.getItem(COMPANY.KEY)) || [];
        if(companies.some(c => c.name.toLowerCase() === companyName.toLowerCase())) {
            alert("Компания с таким именем уже существует!");
            return;
        }

        if(remainingMoney < COMPANY.CREATION_COST) {
            alert("Недостаточно средств!");
            return;
        }

        // Создание компании
        const newCompany = {
            id: Date.now(),
            name: companyName,
            avatar: companyAvatar,
            budget: companyBudget,
            initialBudget: companyBudget,
            lastUpdate: Date.now(),
            lastProfit: 0
        };

        // Обновление баланса
        remainingMoney -= COMPANY.CREATION_COST;
        localStorage.setItem('userMoney1', remainingMoney);
        document.getElementById('user-money').textContent = remainingMoney;

        // Сохранение данных
        companies.push(newCompany);
        localStorage.setItem(COMPANY.KEY, JSON.stringify(companies));
        updateCompanies();
        document.getElementById("companyForm").style.display = "none";

    } catch(error) {
        console.error('Ошибка создания компании:', error);
        alert('Ошибка при создании компании');
    }
}

function updateCompanies() {
    const now = new Date();
    const lastVisitISO = localStorage.getItem('lastVisitTime');
    let totalTaxes = 0; // Добавляем счетчик налогов

    // Получаем время последнего визита 
    let lastVisitTime = now;
    if(lastVisitISO) {
        lastVisitTime = new Date(lastVisitISO);
        if(isNaN(lastVisitTime.getTime())) {
            lastVisitTime = now;
        }
    }

    const companies = JSON.parse(localStorage.getItem(COMPANY.KEY) || '[]');
    let totalProfit = 0;
    let removedCompanies = 0;

    // 1. Удаление компаний с бюджетом < 2500
    const validCompanies = companies.filter(company => {
        if(company.budget < 2500) {
            removedCompanies++;
            return false;
        }
        return true;
    });

    // 2. Расчет интервалов
    const secondsPassed = Math.floor((now - lastVisitTime) / 27);
    const intervals = secondsPassed;

    // 3. Обновление компаний с налогообложением
    if(intervals > 0) {
        validCompanies.forEach(company => {
            const initialBudget = company.budget;
            
            // Генерируем прибыль
            let grossProfit = 0;
            for(let i = 0; i < intervals; i++) {
                const change = company.budget * (Math.random() * 0.004 - 0.002);
                grossProfit += change;
            }
            
            // Рассчитываем налоги
            const taxAmount = taxes(Math.max(0, grossProfit)); // Налог только с положительной прибыли
            const netProfit = grossProfit - taxAmount;
            
            company.budget = Math.max(0, company.budget + netProfit);
            company.lastProfit = netProfit; // Сохраняем чистую прибыль
            
            totalProfit += netProfit;
            totalTaxes += taxAmount; // Аккумулируем налоги
        });
    }

    // 4. Обновление данных
    remainingMoney = Number(remainingMoney) + Math.floor(totalProfit) + Math.floor(totalTaxes) - (removedCompanies * 500);
    localStorage.setItem('userMoney1', remainingMoney);
    document.getElementById('user-money').textContent = remainingMoney;
    
    // Обновляем отображение налогов
    document.getElementById("taxrate").textContent = 
        `С компаний: ${Math.floor(totalTaxes).toLocaleString()}₽`;

    localStorage.setItem('lastVisitTime', now.toISOString());
    localStorage.setItem(COMPANY.KEY, JSON.stringify(validCompanies));
    
    renderCompanies();
}

function renderCompanies() {
    const container = document.getElementById('companiesContainer');
    const companies = JSON.parse(localStorage.getItem(COMPANY.KEY)) || [];
    let totalProfitAll = 0;
    
    // Удаляем предыдущий элемент общей прибыли
    const existingProfitElement = document.getElementById('total-companies-profit');
    if(existingProfitElement) {
        existingProfitElement.remove();
    }

    // Генерируем новый контент
    container.innerHTML = companies.map(company => {
        const totalProfit = company.budget - company.initialBudget;
        totalProfitAll += totalProfit;
        
        const statusClass = totalProfit >= 0 ? 'profit-up' : 'profit-down';
        const statusText = company.budget > 0 ? 'Активна' : 'Банкрот';
        
        const lastProfit = company.lastProfit 
            ? `Последняя прибыль: ${company.lastProfit >= 0 ? '+' : ''}${company.lastProfit.toFixed(2)}₽<br>`
            : '';

        return `
            <div class="inventory-item">
                <h3>${company.name}</h3>
                <img src="${company.avatar}" style="width:60px; height:60px; border-radius:8px;">
                <p>Капитал: ${Math.floor(company.budget).toLocaleString()}₽</p>
                <p class="${statusClass}">
                    ${lastProfit}
                    Общая прибыль: ${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)}₽
                </p>
                <p>Статус: <span class="${company.budget > 0 ? 'profit-up' : 'profit-down'}">
                    ${statusText}
                </span></p>
                <div class="company-actions">
                    <button class="company-btn fund-btn" onclick="fundCompany(${company.id})">Финансировать</button>
                    <button class="company-btn delete-btn" onclick="deleteCompany(${company.id})">Удалить</button>
                </div>
            </div>
        `;
    }).join('');

    // Создаем и добавляем новый элемент общей прибыли
    const totalProfitElement = document.createElement('div');
    totalProfitElement.id = 'total-companies-profit';
    totalProfitElement.textContent = `Общая прибыль: ${totalProfitAll.toLocaleString()}₽`;
    totalProfitElement.style.color = totalProfitAll >= 0 ? '#4CAF50' : '#ff4444';
    totalProfitElement.style.marginTop = '20px';
    totalProfitElement.style.padding = '10px';
    
    container.parentNode.insertBefore(totalProfitElement, container.nextSibling);
}

function fundCompany(companyId) {
    const amount = prompt('Введите сумму финансирования:');
    if(!amount || isNaN(amount)) return;
    
    const companies = JSON.parse(localStorage.getItem(COMPANY.KEY));
    const company = companies.find(c => c.id === companyId);
    const userBalance = Number(localStorage.getItem('userMoney1'));
    
    if(amount > userBalance) {
        alert('Недостаточно средств!');
        return ;
    }
        company.budget += Number(amount);
        localStorage.setItem('userMoney1', userBalance - amount);
        localStorage.setItem(COMPANY.KEY, JSON.stringify(companies));
        updateCompanies();
}

// Функция удаления компании
function deleteCompany(companyId) {
    if(!confirm('Вы уверены, что хотите удалить компанию? Это действие нельзя отменить!')) return;
    
    const companies = JSON.parse(localStorage.getItem(COMPANY.KEY));
    const filtered = companies.filter(c => c.id !== companyId);
    
    localStorage.setItem(COMPANY.KEY, JSON.stringify(filtered));
    updateCompanies();
    alert('Компания успешно удалена!');
}

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    initCompanies();
    updateCompanies();
    document.getElementById('companyBudget').min = COMPANY.MIN_BUDGET;
});
</script>
<div class="category-title">Инвентарь</div>
<div id="inventory" class="inventory">
    <p id='inv'>Ваши покупки появятся здесь.</p>
</div>
    <button class='pay-button' onclick='deleteStrg()'>Удалить все сохранения</button>
<p>Баллы вашей армии: <span id='armyb'>0</span></p>
<p>Налоги на прибыль: <span id="taxrate">0</span></p>
<input type='text' id="promo" style="width: 90%;" placeholder="Ввод промокода"><button onclick="getpromo(document.getElementById('promo').value)" style="border: 1px solid white; background-color: black; color: white; border-radius: 5px; padding: 15px; margin: 15px;">Получить</button>

<div>
        <div class="category-title">Генератор промокодов</div>
        <div class="promosgen">
        <input type="number" id="value1" placeholder="Цена">
        <input type="text" id="value2" placeholder="Получатель">
        <p style='opacity: 0.6'>Учитывайте, что промокоды создаются за ваш счет<br>Оставьте поле с получателем пустым, что бы сделать промокод общим<br>Вы не можете получать свои же промокоды</p>
        <button class='pay-button' onclick="encrypt()">Сгенерировать</button>
        <p id="encryptedResult" onclick='copytext("encryptedResult")'></p>
        </div>
</div>

<script>
    
    function copytext(e) {
    const text = document.getElementById(e).innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert("Скопировано в буфер обмена!");
    }).catch((err) => {
        alert("Ошибка копирования: " + err);
    });
}

        function encrypt() {
             const value1 = document.getElementById('value1').value;
            const value2 = document.getElementById('value2').value;
            
            if (value1.length > 0 && value2.length >= 0 && remainingMoney > value1) {
                
            remainingMoney -= value1
            localStorage.setItem("userMoney1", remainingMoney)
            
            // Кодируем длину value1 в первом символе
            const lengthByte = String.fromCharCode(value1.length + 32);
            const combined = lengthByte + value1 + value2;
            
            // Прогрессивный сдвиг
            let shifted = Array.from(combined).map((c, i) => {
                let code = c.charCodeAt(0);
                return String.fromCharCode((code - 32 + i + 1) % 95 + 32);
            }).join('');
            
            // Перестановка нечетных символов
            let chars = [...shifted];
            let oddChars = chars.filter((_, i) => i % 2).reverse();
            chars = chars.map((c, i) => i % 2 ? oddChars[Math.floor(i/2)] : c);
            
            document.getElementById('encryptedResult').textContent = chars.join('');
            
            const usedPromos = JSON.parse(localStorage.getItem('usedPromos') || '[]');
            
            usedPromos.push(chars.join(''));
            
            localStorage.setItem('usedPromos', JSON.stringify(usedPromos))
        } else {
        alert("Введите суму или получателя! (или у вас недостаточно средств)");
        }
    }

        function decrypt(encrypted) {
            let chars = [...encrypted];
            let oddChars = chars.filter((_, i) => i % 2).reverse();
            chars = chars.map((c, i) => i % 2 ? oddChars[Math.floor(i/2)] : c);
            
            // Обратный сдвиг
            let decrypted = chars.map((c, i) => {
                let code = c.charCodeAt(0);
                return String.fromCharCode((code - 32 - i - 1 + 95) % 95 + 32);
            }).join('');
            
            try {
                const length = decrypted.charCodeAt(0) - 32;
                const value1 = decrypted.substr(1, length);
                const value2 = decrypted.substr(1 + length);
                return [value1, value2];
            } catch(e) {
             console.error(e)
            }
        }
    </script>

<script>
    
const promos = {
  "2025": 1000000,
  "imancat": 400000,
  "kenihukc": 200000,
  "иронмакс2005": 300000,
  "идиоты,янедаюденьгипростотак": 600000,
  "admitone": 200000,
  "промо": 350000,
  "промокод_2025_ёлки_миллион_денег": -1000,
  "ватикан": 100000,
  "бразилиа": 80000,
  "международнаясистематранзакций": 50000
};

function getpromo(p) {
  if (typeof p !== 'string') p = String(p);
  p = p.trim().replace(/\s+/g, '').toLowerCase();
  const usedPromos = JSON.parse(localStorage.getItem('usedPromos') || '[]');

  if (usedPromos.includes(p)) {
    alert("Этот промокод уже был использован!");
    return;
  }

  if (promos[p]) {
    alert(`Вы получили ${promos[p]}! Перезайдите в бота для получения!`);
    localStorage.setItem('userMoney1', Number(localStorage.getItem('userMoney1') || 0) + promos[p]);
    usedPromos.push(p);
    localStorage.setItem('usedPromos', JSON.stringify(usedPromos));
    fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `🔥<b> Промокод получен!</b> \nПользователь: @${user.username}\nЦена промокода: ${promos[p]}₽`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
  } else {
    const ps = decrypt(p);
    if (user.username.toLowerCase().trim() === ps[1].toLowerCase().trim() || ps[1].length == 0) {
        alert(`Вы получили промокод ценой в ${ps[0]}!`);
        // Здесь была пропущена скобка
        localStorage.setItem('userMoney1', Number(localStorage.getItem('userMoney1') || 0) + Number(ps[0]));
        usedPromos.push(p);
        localStorage.setItem('usedPromos', JSON.stringify(usedPromos));
        fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `🔥<b> Промокод получен!</b> \nПользователь: @${user.username}\nЦена промокода: ${ps[0]}₽\nТип промокода: кастомный`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
    } else {
        alert("Промокод не найден!");
    } } }

    
    function dep() {
        let x = document.getElementById("pev").value
        let y = document.getElementById("pev1").value
        if (x <= remainingMoney && x.length > 0 && y.length > 0) {
        remainingMoney -= x;
        localStorage.setItem('userMoney1', remainingMoney);
        alert(`Вы хотите оплатить: ${x} ₽. Ваш новый баланс: ${remainingMoney} ₽`);
        fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `✅ <b>${x}₽ - перевод!</b> \nПользователь: @${user.username}\nЦель: ${y}`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
    } else {
        alert("Введите суму или цель! (или у вас недостаточно средств)");
    }
    }
    
    function deleteStrg() {
            localStorage.removeItem('inventory')
            localStorage.removeItem('userMoney1')
            localStorage.removeItem('usedPromos')
            localStorage.removeItem('userCompanies')
    }
    
    document.querySelectorAll('.item-container input').forEach(input => {
    input.setAttribute('oninput', 'this.value = Math.abs(this.value)');
});

document.addEventListener('keydown', (event) => {
        if (event.key === '-') {
            event.preventDefault();
        }
    })



    function parsinv(text) {
    const inventory = {};

    // Разделяем текст на строки
    const lines = text.trim().split('\n');

    lines.forEach(line => {
        // Разделяем строку по символу '×'
        if (line.includes('×')) {
            const [item, quantity] = line.split('×').map(part => part.trim());
            const qty = parseInt(quantity, 10);

            // Добавляем товар в объект или увеличиваем его количество
            if (inventory[item]) {
                inventory[item] += qty;
            } else {
                inventory[item] = qty;
            }
        }
    });

    // Преобразуем объект обратно в строку
    const result = Object.entries(inventory)
        .map(([item, quantity]) => `${item} × ${quantity}`)
        .join('\n');

    return result;
}

function sendCash(cost, remain, bought) {
    fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `💠 <b>${cost}₽ - прибыль!</b> \nПользователь: @${user.username}\nСчёт: ${remain}₽\nБаллы армии: ${armyballs}\nНалог: ${taxr}₽\nИнвентарь:\n-------\n${bought}`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
}

</script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let user;

        // Проверяем, если приложение не используется в Telegram Web App, создаём тестового пользователя
        if (true) {
            //localStorage.setItem('userMoney', 5);
            user = {
                first_name: "Пр<br>",
                last_name: "Ваши транзакции не записываются<br>Это тестовый аккаунт",
                username: "iron",
                photo_url: 'https://masterpiecer-images.s3.yandex.net/5fb594277c19885:upscaled'
            };
        } else {
            Telegram.WebApp.ready();
            user = Telegram.WebApp.initDataUnsafe.user;
        }

        // Устанавливаем данные пользователя
        document.getElementById('avatar').src = user.photo_url || 'https://via.placeholder.com/100';
        document.getElementById('name').innerHTML = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('username').innerText = '@' + (user.username || 'unknown');
        
        const users = {
            'ирон макс 2005': { money: 9999999 }
        };
        
//localStorage.removeItem("userMoney1")
        // Устанавливаем баланс текущего пользователя
        const currentUserMoney = users[user.username] ? users[user.username].money : 6000000;
        let totalCost = 0;
        let remainingMoney = currentUserMoney;
    
        if (!localStorage.getItem("if3")) {
            deleteStrg()
            localStorage.setItem("if3", true)
        }

        // Сохраняем начальный баланс в localStorage
        if (!localStorage.getItem('userMoney1')) {
            localStorage.setItem('userMoney1', currentUserMoney);
        } else {
            remainingMoney = parseInt(localStorage.getItem('userMoney1'));
        }

        // Функции увеличения и уменьшения количества товара
        function updateTotalCost() {
    totalCost = 0;
    let boughtItems = ''; // Строка для хранения купленных товаров

    const itemContainers = document.querySelectorAll('.item-container');
itemContainers.forEach(item => {
    const input = item.querySelector('input');
    if (!input) return; // Если input не найден, пропускаем итерацию

    const quantity = parseInt(input.value) || 0; // Если пусто, считаем как 0
    const price = parseInt(item.getAttribute('data-price')) || 0;
    const itemName = item.querySelector('.item-name')?.innerText || 'Unknown';

    if (quantity > 0) {
        boughtItems += `${itemName} × ${quantity}\n`;
    }

    totalCost += quantity * price * (taxr + 1);
});


    if (boughtItems !== '') {
        let items = boughtItems.split('\n').length - 1
        let tovar = (items === 1) ? ' товар' : (items >= 2 && items <= 4) ? ' товара' : ' товаров';
        boughtItems += '-------\nВсего: ' + items + tovar; // Добавляем количество товаров
    }

    document.getElementById('total-cost').innerText = totalCost;
    document.getElementById('remaining-money').innerText = remainingMoney - totalCost;

    return boughtItems;
}
function updateTotalCostinv() {
    totalCost = 0;
    let boughtItems = ''; // Строка для хранения купленных товаров

    const itemContainers = document.querySelectorAll('.item-container');
    itemContainers.forEach(item => {
        const quantity = parseInt(item.querySelector('input').value);
        const price = parseInt(item.getAttribute('data-price'));
        const itemName = item.querySelector('.item-name').innerText;
        
        if (quantity > 0) {
            boughtItems += `${itemName} × ${quantity}\n`;
        }
        
        totalCost += quantity * price;
    });

    return boughtItems;
}

        document.querySelectorAll('.increase').forEach(button => {
            button.addEventListener('click', function() {
                const quantitySpan = this.parentElement.querySelector('input');
                let quantity = parseInt(quantitySpan.value);
                quantitySpan.value = quantity + 1;
                updateTotalCost();
            });
        });

        document.querySelectorAll('.decrease').forEach(button => {
            button.addEventListener('click', function() {
                const quantitySpan = this.parentElement.querySelector('input');
                let quantity = parseInt(quantitySpan.value);
                if (quantity > 0) {
                    quantitySpan.value = quantity - 1;
                    updateTotalCost();
                }
            });
        });
        
        document.querySelectorAll('.quantity-control input').forEach(input => {
    input.addEventListener('input', function() {
        // Гарантируем, что значение не меньше 0
        if (this.value < 0) this.value = 0; 
        updateTotalCost();
    });
});

        function sendItem(cost, remain, bought) {
    fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `💱 <b>${cost}₽ </b>\nПользователь: @${user.username}\nСчёт: ${remain}\n\nКуплено:\n-------\n${bought}`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
}

        function sendItemdis(cost, remain, bought) {
    fetch('https://api.telegram.org/bot8048208715:AAHfwiObbcpXzdHfY62_gKzYdazVpsTb5GQ/sendMessage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            chat_id: '-1002485443398',
            text: `❌ <b>${cost}₽ </b>\nПользователь: @${user.username}\nСчёт: ${remain}\n\nОтказано:\n-------\n${bought}`, 
            message_thread_id: 23,
            parse_mode: 'HTML'
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
}

        function pay() {
    if (totalCost <= remainingMoney) {
        remainingMoney -= totalCost;
        localStorage.setItem('userMoney1', remainingMoney);
        const boughtItems = updateTotalCost();
        const inventar = `${localStorage.getItem('inventory')}${updateTotalCostinv()}`
        localStorage.setItem('inventory', `${parsinv(inventar)}\n`);
        document.getElementById('inv').innerText = localStorage.getItem('inventory');
        alert(`Вы хотите оплатить: ${totalCost} ₽. Ваш новый баланс: ${remainingMoney} ₽`);
        sendItem(totalCost, remainingMoney, boughtItems); // Передаем в sendItem
    } else {
        alert("У вас недостаточно средств!");
        const boughtItems = updateTotalCost(); // Получаем список покупок
        sendItemdis(totalCost, remainingMoney, boughtItems);
    }
}
        if (localStorage.getItem('inventory') === null) {
            localStorage.setItem('inventory', '');
        }
        document.getElementById('inv').innerText = parsinv(localStorage.getItem('inventory'));
        document.getElementById('user-money').innerText = remainingMoney
        
        function parseInventoryToObject(text) {
    const inventory = {};

    // Разделяем текст на строки
    const lines = text.trim().split('\n');

    lines.forEach(line => {
        // Разделяем строку по символу '×'
        if (line.includes('×')) {
            const [item, quantity] = line.split('×').map(part => part.trim());
            const qty = parseInt(quantity, 10);

            // Добавляем товар в объект или увеличиваем его количество
            if (inventory[item]) {
                inventory[item] += qty;
            } else {
                inventory[item] = qty;
            }
        }
    });

    return inventory;
}
    </script>
    <script>
const earningsPerMinute = {
    "Нефтяная вышка": 25 / 1000,
    "Завод": 30 / 1000,
    "Аэропорт": 40 / 1000,
    "Банк": 80 / 1000,
    "Ферма": 40 / 1000,
    "Горнодобывающая фабрика": 35 / 1000,
    "Торговый центр": 70 / 100,
    "Энергетическая станция": 115 / 1000,
    "Рынок": 60 / 1000,
    "Мельница": 1 / 1000,
    "Международная торговля": 35 / 1000,
    "Плюшевый спамтон": 0.7 / 1000
};

const army = {
    "Танк": 5, 
    "Самолет": 15,      
    "Вертолет": 3,      
    "Ракетница": 1,     
    "Пушки": 2,         
    "Снайперская винтовка": 5,  
    "Подводная лодка": 6,     
    "Гарнизон": 8,      
    "Морской флот": 12, 
    "Солдат": 1 
};

function parseto(text) {
    text = String(text);
    const inventory = {};
    const lines = text.trim().split('\n');
    lines.forEach(line => {
        if (line.includes('×')) {
            const [item, quantity] = line.split('×').map(part => part.trim());
            const qty = parseInt(quantity, 10);
            if (inventory[item]) {
                inventory[item] += qty;
            } else {
                inventory[item] = qty;
            }
        }
    });

    return inventory;
}

function parsetoarmy(text) {
    text = String(text);
    const inventory = {};
    const lines = text.trim().split('\n');
    
    lines.forEach(line => {
        if (line.includes('×')) {
            const [item, quantity] = line.split('×').map(part => part.trim());
            const qty = parseInt(quantity, 10);
            
            // Проверяем, если элемент принадлежит армии
            if (army[item] !== undefined) {
                if (inventory[item]) {
                    inventory[item] += qty;
                } else {
                    inventory[item] = qty;
                }
            }
        }
    });

    return inventory;
}

function calcpoints(inventory) {
    let totalPoints = 0;

    for (let item in inventory) {
        if (army[item] !== undefined) {
            totalPoints += inventory[item] * army[item];
        }
    }

    return totalPoints;
}
let taxr = 0;

function taxes(profit) {
    if (profit <= 0) return 0;
    const BREAKPOINT = 700;
    const TARGET_PROFIT = 1000000000;
    const MIN_RATE = 5;
    const MAX_RATE = 99;
    const logProfit = Math.log10(profit);
    const logMin = Math.log10(BREAKPOINT);
    const logMax = Math.log10(TARGET_PROFIT);
    let taxRate = MIN_RATE + 
        ((logProfit - logMin) / (logMax - logMin)) * 
        (MAX_RATE - MIN_RATE);
    taxRate = Math.min(taxRate, MAX_RATE);
    taxRate = Math.max(taxRate, MIN_RATE);
    return Number((profit * (taxRate / 100)).toFixed(2));
}

// Обновленная функция расчета
function calculate(inventoryText) {
    const inventory = parseto(inventoryText);
    const currentTime = new Date();
    const lastVisitTime = localStorage.getItem('lastVisitTime');
    let totalEarnings = 0;

    if (!lastVisitTime) {
        localStorage.setItem('lastVisitTime', currentTime.toISOString());
    } else {
        const lastVisit = new Date(lastVisitTime);
        const timeDifference = Math.floor((currentTime - lastVisit) / (100 * 80));
        
        if (timeDifference > 0) {
            for (const item of Object.keys(earningsPerMinute)) {
                if (inventory[item]) {
                    const quantity = inventory[item];
                    const perMinute = earningsPerMinute[item] || 0.5 / 100;
                    totalEarnings += quantity * perMinute * timeDifference;
                }
            }
        }
    }
    
    

    // Вычисляем налог ТОЛЬКО от прибыли
    const taxAmount = taxes(totalEarnings);
    if (taxAmount > 0) {
        taxr = taxAmount;
        document.getElementById("taxrate").innerText = taxAmount
    }
    const netProfit = totalEarnings - taxAmount;

    localStorage.setItem('lastVisitTime', currentTime.toISOString());
    return Math.floor(netProfit); // Возвращаем только чистую прибыль
}
let inv_nonparsed = localStorage.getItem('inventory')
let inv_parsed = calculate(inv_nonparsed)
var armyballs = parseInt(calcpoints(parsetoarmy(inv_nonparsed)));
sendCash(parseInt(inv_parsed), parseInt(localStorage.getItem('userMoney1')) + calculate(inv_nonparsed), parsinv(inv_nonparsed))
if (inv_parsed > 0) {
    let currentBalance = Number(localStorage.getItem('userMoney1')) || 0;
    currentBalance += inv_parsed;
    localStorage.setItem('userMoney1', currentBalance);
}
remainingMoney = localStorage.getItem('userMoney1')
document.getElementById('user-money').innerText = remainingMoney
document.getElementById('armyb').innerText = armyballs;
</script>
</body>
</html>

</body>
</html>
</body>
</html>
